# Mutating Admission Webhook для автоматического добавления nodeSelector и tolerations
# к KuberoApp при создании

apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: kubero-vps-webhook
webhooks:
- name: kubero-vps.kubero.dev
  clientConfig:
    service:
      name: kubero-vps-webhook
      namespace: kubero-system
      path: "/mutate"
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["kubero.dev"]
    apiVersions: ["v1alpha1"]
    resources: ["kuberoapps"]
  admissionReviewVersions: ["v1", "v1beta1"]
  sideEffects: None
  failurePolicy: Fail

---
# Service для webhook
apiVersion: v1
kind: Service
metadata:
  name: kubero-vps-webhook
  namespace: kubero-system
spec:
  ports:
  - port: 443
    targetPort: 9443
  selector:
    app: kubero-vps-webhook

---
# Deployment для webhook сервера
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubero-vps-webhook
  namespace: kubero-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kubero-vps-webhook
  template:
    metadata:
      labels:
        app: kubero-vps-webhook
    spec:
      containers:
      - name: webhook
        image: your-registry/kubero-vps-webhook:latest
        ports:
        - containerPort: 9443
        env:
        - name: DEFAULT_NODE_TYPE
          value: "vps"
        - name: DEFAULT_PAAS_TIER
          value: "tenant"
        volumeMounts:
        - name: cert
          mountPath: /etc/webhook/certs
          readOnly: true
      volumes:
      - name: cert
        secret:
          secretName: kubero-vps-webhook-certs

